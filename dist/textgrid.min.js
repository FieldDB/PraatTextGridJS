/*! textgrid - v2.2.0 - 2014-05-19
* https://github.com/OpenSourceFieldlinguistics/PraatTextGridJS
* Copyright (c) 2014 OpenSourceFieldLinguistics Contribs; Licensed Apache 2.0 */
!function(a){"use strict";var b={};b.init=function(){return"init"};var c=function(a){for(var b,c,d,e={},f=0;f<a.length;f++)b=a[f].split(" = "),c=b[0].trim().replace(/ /g,"_"),d=b[1].trim().replace(/"/g,""),e[c]=d;return e};b.textgridToJSON=function(a){for(var b,d,e,f,g,h=a.split("\n"),i={items:[]},j=null,k="Unknown",l=[];h.length>0;)if(b=h.shift())if(0!==b.search(/ /))d=b.split(" = "),2===d.length&&(f=d[0].trim().replace(/ /g,"_"),g=d[1].trim().replace(/"/g,""),i[f]=g,"File_name"===f&&(k=g+"",console.log(" Found a file name "+k),l.push(k)));else if(-1!==b.search(/\[[\0-9]+\]/)){if(d=b.split("["),e=d[0].trim(),"item"===e)console.log("  Found an item for "+k),j&&(j.fileName=k,i.items.push(j)),j={};else if("points"===e){var m=c([h.shift(),h.shift()]);j[e]=j[e]||[],j[e].push(m)}else if("intervals"===e){var n=c([h.shift(),h.shift(),h.shift()]);j[e]=j[e]||[],j[e].push(n)}}else d=b.split(" = "),2===d.length&&(f=d[0].trim().replace(/ /g,"_"),g=d[1].trim().replace(/"/g,""),f.indexOf(":_size")>-1&&(f=f.replace(":_","_"),g=parseInt(g,10)),j[f]=g);else b=h.shift(),b||(j&&(j.fileName=k,i.items.push(j)),j=null,k="Unknown",console.log("Reset filename if there is are two empty lines"));return j&&(j.fileName=k,i.items.push(j)),i.fileNames=l,i},b.textgridToIGT=function(a,b){return this.jsonToIGT(this.textgridToJSON(a,b),b)},b.jsonToIGT=function(a,b){var c={};a.intervalsByXmin={},a.intervalsByText={};var d,e,f,g,h,i,j,k,l=!1,m=0,n=/[ #?!'".,\/\(\)\*\#0-9-]/g,o=a.items.map(function(a){return a.name.indexOf("@")>-1&&(a.speaker=a.name.substring(a.name.indexOf("@")+1).trim(),a.name=a.name.substring(0,a.name.indexOf("@")).trim(),m++),b&&(a.speaker=a.name),"silences"===a.name&&(a.name="utterances"),a.name});if(o.length-m===0&&(l=!0),!a||!a.items)return a;for(d=0;d<a.items.length;d++)if(c[a.items[d].name]=a.items[d].intervals_size||a.items[d].points_size,a.items[d].intervals)for(e=0;e<a.items[d].intervals.length;e++)f=this.marginForConsideringIntervalsMatching(a.items[d].intervals[e].xmin),g=this.marginForConsideringIntervalsMatching(a.items[d].intervals[e].xmax),i=a.items[d].intervals[e],i.fileName=a.items[d].fileName,i.tierName=a.items[d].name,i.speaker=a.items[d].speaker,h=f+":"+g,a.intervalsByXmin[h]=a.intervalsByXmin[h]||[],a.intervalsByXmin[h].push(i),j=i.text?i.text.trim().toLocaleLowerCase().replace(n,""):"",j&&("utterance"===j&&a.items[d].intervals.length<3&&(j=i.fileName,j.indexOf(".")>-1&&(j=j.substring(0,i.fileName.lastIndexOf("."))),j=j.trim().replace(/_/g," "),i.text=j),a.intervalsByText[j]=a.intervalsByText[j]||[],k=a.intervalsByText[j].length,a.intervalsByText[j][k]=i);return a.probablyFromElanWithSpeakerEncodedInTierName=l,a.isIGTNestedOrAlignedOrBySpeaker=this.isIGTNestedOrAlignedOrBySpeaker(a),a},b.isIGTNestedOrAlignedOrBySpeaker=function(a){var b,c,d=a.intervalsByXmin,e={},f=0,g=!1,h=!1;for(var i in a.items)a.items.hasOwnProperty(i)&&a.items[i].speaker&&(g=!0);for(c in d)e[d[c].length]=e[d[c].length]?e[d[c].length]+1:1,f++;for(b in e)e[b]=e[b]/f,b>1&&e[b]>.1&&(h=!0);return a.fileNames&&a.fileNames.length>4&&(h=!1),{histogram:e,probablyAligned:h,probablyBySpeaker:g}},b.marginForConsideringIntervalsMatching=function(a,b){return b=b?100/b:5,(Math.round(a*b)/b).toFixed(2)},b.printIGT=function(a){var b=function(a){return a.xmin+","+a.xmax+","+a.text};for(var c in a)console.log(c),a.hasOwnProperty(c)&&console.log(a[c].map(b))},a.TextGrid=b}("object"==typeof exports&&exports||this);