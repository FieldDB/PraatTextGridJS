/*! textgrid - v2.2.0 - 2021-12-14
* https://github.com/OpenSourceFieldlinguistics/PraatTextGridJS
* Copyright (c) 2021 OpenSourceFieldLinguistics Contribs; Licensed Apache 2.0 */

!function(e){"use strict";function h(e){for(var t,i,n={},r=0;r<e.length;r++)t=(i=e[r].split(" = "))[0].trim().replace(/ /g,"_"),i=i[1].trim().replace(/"/g,""),n[t]=i;return n}var t={init:function(){return"init"}};t.textgridToJSON=function(e,t){for(var i,n,r,s,a,l,m=e.split("\n"),o={items:[]},f=null,g="Unknown",p=[];0<m.length;)(l=m.shift())?0!==l.search(/ /)&&0!==l.search(/\t/)?2===(s=l.split(" = ")).length&&(i=s[0].trim().replace(/ /g,"_"),n=s[1].trim().replace(/"/g,""),o[i]=n,"File_name"===i&&(g=n+"",console.log(" Found a file name "+g),p.push(g))):-1!==l.search(/\[[\0-9]+\]/)?"item"===(a=(s=l.split("["))[0].trim())?(console.log("  Found an item for "+g),f&&(f.fileName=g,o.items.push(f)),f={}):"points"===a?(r=h([m.shift(),m.shift()]),f[a]=f[a]||[],f[a].push(r)):"intervals"===a&&(r=h([m.shift(),m.shift(),m.shift()]),f[a]=f[a]||[],f[a].push(r)):2===(s=l.split(" = ")).length&&(i=s[0].trim().replace(/ /g,"_"),n=s[1].trim().replace(/"/g,""),-1<i.indexOf(":_size")&&(i=i.replace(":_","_"),n=parseInt(n,10)),f[i]=n):(l=m.shift())||(f&&(f.fileName=g,o.items.push(f)),f=null,g="Unknown",console.log("Reset filename if there is are two empty lines"));return f&&(f.fileName=g,o.items.push(f)),o.fileNames=p,o},t.textgridToIGT=function(e,t){return this.jsonToIGT(this.textgridToJSON(e,t),t)},t.jsonToIGT=function(e,t){var i,n,r={};e.intervalsByXmin={};var s,a,l,m=!(e.intervalsByText={}),o=0,f=/[ #?!'".,\/\(\)\*\#0-9-]/g;if(e.items.map(function(e){return-1<e.name.indexOf("@")&&(e.speaker=e.name.substring(e.name.indexOf("@")+1).trim(),e.name=e.name.substring(0,e.name.indexOf("@")).trim(),o++),t&&(e.speaker=e.name),"silences"===e.name&&(e.name="utterances"),e.name}).length-o==0&&(m=!0),!e||!e.items)return e;for(i=0;i<e.items.length;i++)if(r[e.items[i].name]=e.items[i].intervals_size||e.items[i].points_size,e.items[i].intervals)for(n=0;n<e.items[i].intervals.length;n++)l=this.marginForConsideringIntervalsMatching(e.items[i].intervals[n].xmin),a=this.marginForConsideringIntervalsMatching(e.items[i].intervals[n].xmax),(s=e.items[i].intervals[n]).fileName=e.items[i].fileName,s.tierName=e.items[i].name,s.speaker=e.items[i].speaker,e.intervalsByXmin[l=l+":"+a]=e.intervalsByXmin[l]||[],e.intervalsByXmin[l].push(s),(a=s.text?s.text.trim().toLocaleLowerCase().replace(f,""):"")&&("utterance"===a&&e.items[i].intervals.length<3&&(a=(a=-1<(a=s.fileName).indexOf(".")?a.substring(0,s.fileName.lastIndexOf(".")):a).trim().replace(/_/g," "),s.text=a),e.intervalsByText[a]=e.intervalsByText[a]||[],l=e.intervalsByText[a].length,e.intervalsByText[a][l]=s);return e.probablyFromElanWithSpeakerEncodedInTierName=m,e.isIGTNestedOrAlignedOrBySpeaker=this.isIGTNestedOrAlignedOrBySpeaker(e),e},t.isIGTNestedOrAlignedOrBySpeaker=function(e){var t,i,n,r=e.intervalsByXmin,s={},a=0,l=!1,m=!1;for(n in e.items)e.items.hasOwnProperty(n)&&e.items[n].speaker&&(l=!0);for(i in r)s[r[i].length]=s[r[i].length]?s[r[i].length]+1:1,a++;for(t in s)s[t]=s[t]/a,1<t&&.1<s[t]&&(m=!0);return{histogram:s,probablyAligned:m=e.fileNames&&4<e.fileNames.length?!1:m,probablyBySpeaker:l}},t.marginForConsideringIntervalsMatching=function(e,t){return t=t?100/t:5,(Math.round(e*t)/t).toFixed(2)},t.printIGT=function(e){function t(e){return e.xmin+","+e.xmax+","+e.text}for(var i in e)console.log(i),e.hasOwnProperty(i)&&console.log(e[i].map(t))},e.TextGrid=t}("object"==typeof exports&&exports||this);